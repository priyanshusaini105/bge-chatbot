<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGE ELECTRIQUE - Upload PDF</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex items-center justify-center px-4 py-12">
        <div class="max-w-2xl w-full bg-white rounded-2xl border-2 border-gray-200 p-8">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-black mb-2 tracking-[0.15em]">BGE ELECTRIQUE</h1>
                <p class="text-gray-600">Upload PDF Document</p>
            </div>

            <!-- Upload Form -->
            <div id="uploadArea" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center transition-colors hover:border-black">
                <div class="mb-4">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <label for="pdfFile" class="cursor-pointer">
                    <span class="mt-2 block text-sm font-semibold text-gray-900">Click to upload PDF</span>
                    <span class="mt-1 block text-xs text-gray-500">or drag and drop</span>
                    <span class="mt-2 block text-xs text-gray-400">PDF up to 50MB</span>
                </label>
                <input type="file" id="pdfFile" accept=".pdf" class="hidden">
            </div>

            <!-- Selected File Info -->
            <div id="fileInfo" class="hidden mt-6 p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <svg class="h-10 w-10 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                        </svg>
                        <div>
                            <p id="fileName" class="text-sm font-medium text-gray-900"></p>
                            <p id="fileSize" class="text-xs text-gray-500"></p>
                        </div>
                    </div>
                    <button id="removeFile" class="text-gray-400 hover:text-red-600">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Upload Button -->
            <button id="uploadBtn" disabled class="w-full mt-6 px-6 py-3 bg-black text-white rounded-full font-bold text-sm tracking-wider transition-all duration-300 hover:bg-gray-800 hover:scale-105 active:scale-95 disabled:opacity-30 disabled:cursor-not-allowed disabled:hover:scale-100">
                UPLOAD PDF
            </button>

            <!-- Progress Bar -->
            <div id="progressContainer" class="hidden mt-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">Uploading...</span>
                    <span id="progressPercent" class="text-sm font-medium text-gray-700">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="progressBar" class="bg-black h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- Status Messages -->
            <div id="statusMessage" class="hidden mt-6 p-4 rounded-lg"></div>

            <!-- Back to Chat Link -->
            <div class="mt-8 text-center">
                <a href="index.html" class="text-sm text-gray-600 hover:text-black transition-colors">
                    ‚Üê Back to Chat
                </a>
            </div>

            <!-- API Status -->
            <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-600">Backend Status:</span>
                    <div class="flex items-center gap-2">
                        <span id="apiStatus" class="w-2 h-2 rounded-full bg-gray-400"></span>
                        <span id="apiStatusText" class="text-xs text-gray-600">Checking...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000';
        let selectedFile = null;

        // Elements
        const elements = {
            pdfFile: document.getElementById('pdfFile'),
            uploadArea: document.getElementById('uploadArea'),
            fileInfo: document.getElementById('fileInfo'),
            fileName: document.getElementById('fileName'),
            fileSize: document.getElementById('fileSize'),
            removeFile: document.getElementById('removeFile'),
            uploadBtn: document.getElementById('uploadBtn'),
            progressContainer: document.getElementById('progressContainer'),
            progressBar: document.getElementById('progressBar'),
            progressPercent: document.getElementById('progressPercent'),
            statusMessage: document.getElementById('statusMessage'),
            apiStatus: document.getElementById('apiStatus'),
            apiStatusText: document.getElementById('apiStatusText')
        };

        // Check API status on load
        checkAPIStatus();

        // File input change
        elements.pdfFile.addEventListener('change', (e) => {
            handleFileSelect(e.target.files[0]);
        });

        // Drag and drop
        elements.uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            elements.uploadArea.classList.add('border-black', 'bg-gray-50');
        });

        elements.uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            elements.uploadArea.classList.remove('border-black', 'bg-gray-50');
        });

        elements.uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            elements.uploadArea.classList.remove('border-black', 'bg-gray-50');
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'application/pdf') {
                handleFileSelect(file);
            }
        });

        // Remove file
        elements.removeFile.addEventListener('click', () => {
            selectedFile = null;
            elements.pdfFile.value = '';
            elements.fileInfo.classList.add('hidden');
            elements.uploadBtn.disabled = true;
        });

        // Upload button
        elements.uploadBtn.addEventListener('click', uploadPDF);

        function handleFileSelect(file) {
            if (!file || file.type !== 'application/pdf') {
                showStatus('Please select a valid PDF file', 'error');
                return;
            }

            if (file.size > 50 * 1024 * 1024) {
                showStatus('File size must be under 50MB', 'error');
                return;
            }

            selectedFile = file;
            elements.fileName.textContent = file.name;
            elements.fileSize.textContent = formatFileSize(file.size);
            elements.fileInfo.classList.remove('hidden');
            elements.uploadBtn.disabled = false;
        }

        async function uploadPDF() {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('pdf', selectedFile);

            elements.uploadBtn.disabled = true;
            elements.progressContainer.classList.remove('hidden');
            showStatus('Processing PDF...', 'info');

            try {
                // Simulate progress for better UX
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    if (progress <= 90) {
                        updateProgress(progress);
                    }
                }, 200);

                const response = await fetch(`${API_URL}/api/pdf/upload`, {
                    method: 'POST',
                    body: formData
                });

                clearInterval(progressInterval);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Upload failed');
                }

                const data = await response.json();
                updateProgress(100);

                showStatus(
                    `PDF uploaded successfully!<br>Processed ${data.chunks} chunks from "${data.fileName}"`,
                    'success'
                );

                // Reset after 3 seconds
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);

            } catch (error) {
                console.error('Upload error:', error);
                showStatus(`Upload failed: ${error.message}`, 'error');
                elements.uploadBtn.disabled = false;
            }
        }

        async function checkAPIStatus() {
            try {
                const response = await fetch(`${API_URL}/api/health`);
                if (response.ok) {
                    elements.apiStatus.classList.remove('bg-gray-400');
                    elements.apiStatus.classList.add('bg-green-500');
                    elements.apiStatusText.textContent = 'Connected';
                } else {
                    throw new Error('API not responding');
                }
            } catch (error) {
                elements.apiStatus.classList.remove('bg-gray-400');
                elements.apiStatus.classList.add('bg-red-500');
                elements.apiStatusText.textContent = 'Disconnected';
            }
        }

        function updateProgress(percent) {
            elements.progressBar.style.width = `${percent}%`;
            elements.progressPercent.textContent = `${percent}%`;
        }

        function showStatus(message, type) {
            elements.statusMessage.classList.remove('hidden', 'bg-green-50', 'bg-red-50', 'bg-blue-50', 'text-green-800', 'text-red-800', 'text-blue-800');
            
            if (type === 'success') {
                elements.statusMessage.classList.add('bg-green-50', 'text-green-800');
            } else if (type === 'error') {
                elements.statusMessage.classList.add('bg-red-50', 'text-red-800');
            } else {
                elements.statusMessage.classList.add('bg-blue-50', 'text-blue-800');
            }

            elements.statusMessage.innerHTML = message;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
    </script>
</body>
</html>
